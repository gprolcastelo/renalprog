name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9]

    steps:
    - uses: actions/checkout@v3

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install minimal dependencies
      run: |
        python -m pip install --upgrade pip
        # Install CPU-only PyTorch to save space (~500MB vs ~2.5GB)
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        # Install only core dependencies needed for tests (use version constraints to save space)
        pip install pytest pytest-cov
        pip install 'numpy>=1.24.0,<2.0.0' 'pandas>=2.0.0,<2.2.0' 'scikit-learn>=1.3.0,<1.4.0'
        pip install matplotlib seaborn tqdm scipy h5py
        # Install additional core dependencies
        pip install requests pydeseq2 statsmodels networkx graphviz pyyaml colorlog plotly umap-learn
        # Install package in editable mode without full dependencies
        pip install -e . --no-deps
        # Show disk space after installation
        df -h

    - name: Run tests
      run: pytest tests/test_dataset.py tests/test_features.py tests/test_modeling.py -v --tb=short -m "not slow and not requires_heavy_deps" --maxfail=5
